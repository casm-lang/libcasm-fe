
Specification
: CASM Definitions

Definition
: FunctionDefinition
| DerivedDefinition
| RuleDefinition
| EnumerationDefinition
| error // error recovery

AttributedDefinition
: LSQPAREN Attributes RSQPAREN Definition
| Definition

Definitions
: Definitions AttributedDefinition
| AttributedDefinition

FunctionDefinition
: FUNCTION Identifier COLON MaybeFunctionParameters MAPS Type MaybeDefined MaybeInitially
| ProgramFunctionDefinition

MaybeInitially
: INITIALLY LCURPAREN MaybeInitializers RCURPAREN
| %empty

MaybeDefined
: DEFINED LCURPAREN Term RCURPAREN
| %empty

FunctionParameters
: FunctionParameters ASTERIX Type
| Type

MaybeFunctionParameters
: FunctionParameters
| %empty

ProgramFunctionDefinition
: INIT IdentifierPath
| INIT LCURPAREN MaybeInitializers RCURPAREN

Initializer
: Term
| Term MAPS Term
| TwoOrMoreArguments MAPS Term // the rule above can be (arg)->... so force >=2 args here to avoid a shift/reduce conflict

Initializers
: Initializers COMMA Initializer
| Initializer

MaybeInitializers
: Initializers
| %empty

DerivedDefinition
: DERIVED Identifier MaybeParameters MAPS Type EQUAL Term

EnumerationDefinition
: ENUM Identifier EQUAL LCURPAREN Identifiers RCURPAREN

Identifier
: IDENTIFIER
| IN // allow in keyword as identifier

Identifiers
: Identifiers COMMA Identifier
| Identifier

DotSeparatedIdentifiers
: DotSeparatedIdentifiers DOT Identifier
| Identifier

IdentifierPath
: DotSeparatedIdentifiers %prec ABSOLUTE_PATH
| DOT DotSeparatedIdentifiers

Variable
: Identifier COLON Type
| Identifier

AttributedVariable
: LSQPAREN Attributes RSQPAREN Variable
| Variable

Parameters
: Parameters COMMA AttributedVariable
| AttributedVariable

MaybeParameters
: LPAREN Parameters RPAREN
| LPAREN error RPAREN // error recovery
| %empty

Type
: BasicType
| ComposedType
| RelationType
| FixedSizedType

BasicType
: IdentifierPath

ComposedType
: IdentifierPath LESSER Types GREATER

RelationType
: IdentifierPath LESSER MaybeFunctionParameters MAPS Type GREATER

FixedSizedType
: IdentifierPath MARK Term

Types
: Types COMMA Type
| Type

Atom
: Reference
| BitNumber
| IntegerNumber
| FloatingNumber
| RationalNumber
| String
| Undefined
| Boolean

Undefined
: UNDEF

Boolean
: TRUE
| FALSE

String
: STRING

BitNumber
: BINARY
| HEXADECIMAL

IntegerNumber
: INTEGER

FloatingNumber
: FLOATING

RationalNumber
: RATIONAL

Reference
: AT IdentifierPath

Term
: DirectCallExpression
| IndirectCallExpression
| ConditionalExpression
| ChooseExpression
| UniversalQuantifierExpression
| ExistentialQuantifierExpression
| Expression
| List
| Range
| Atom

Expression
: LPAREN Term RPAREN
| LPAREN error RPAREN // error recovery
| PLUS Term %prec UPLUS
| MINUS Term %prec UMINUS
| Term PLUS Term
| Term MINUS Term
| Term ASTERIX Term
| Term SLASH Term
| Term PERCENT Term
| Term CARET Term
| Term NEQUAL Term
| Term EQUAL Term
| Term LESSER Term
| Term GREATER Term
| Term LESSEQ Term
| Term GREATEREQ Term
| Term OR Term
| Term XOR Term
| Term AND Term
| Term ARROW Term
| Term IMPLIES Term
| NOT Term

Range
: LSQPAREN Term DOTDOT Term RSQPAREN

List
: LSQPAREN RSQPAREN
| LSQPAREN Terms RSQPAREN
| LSQPAREN error RSQPAREN // error recovery

Terms
: Terms COMMA Term
| Term

Arguments
: LPAREN Terms RPAREN
| LPAREN error RPAREN // error recovery
| LPAREN RPAREN

TwoOrMoreArguments
: LPAREN Term COMMA Terms RPAREN

DirectCallExpression
: IdentifierPath %prec CALL_WITHOUT_ARGS
| IdentifierPath Arguments

IndirectCallExpression
: LPAREN ASTERIX Term RPAREN Arguments

ConditionalExpression
: IF Term THEN Term ELSE Term

ChooseExpression
: CHOOSE AttributedVariable IN Term DO Term

UniversalQuantifierExpression
: FORALL AttributedVariable IN Term HOLDS Term

ExistentialQuantifierExpression
: EXISTS AttributedVariable IN Term WITH Term

RuleDefinition
: RULE Identifier MaybeParameters EQUAL Rule
| RULE Identifier MaybeParameters MAPS Type EQUAL Rule

Rule
: SkipRule
| ConditionalRule
| CaseRule
| LetRule
| ForallRule
| ChooseRule
| IterateRule
| BlockRule
| SequenceRule
| UpdateRule
| CallRule

Rules
: Rules Rule
| Rule

SkipRule
: SKIP

ConditionalRule
: IF Term THEN Rule
| IF Term THEN Rule ELSE Rule

CaseRule
: CASE Term OF LCURPAREN CaseLabels RCURPAREN
| CASE Term OF LCURPAREN error RCURPAREN // error recovery

CaseLabel
: DEFAULT COLON Rule
| UNDERLINE COLON Rule
| Term COLON Rule

CaseLabels
: CaseLabel CaseLabels
| CaseLabel

LetRule
: LET AttributedVariable EQUAL Term IN Rule

ForallRule
: FORALL AttributedVariable IN Term DO Rule

ChooseRule
: CHOOSE AttributedVariable IN Term DO Rule

IterateRule
: ITERATE Rule

BlockRule
: LCURPAREN Rules RCURPAREN
| PAR Rules ENDPAR
| LCURPAREN error RCURPAREN // error recovery
| PAR error ENDPAR // error recovery

SequenceRule
: SEQ_BRACKET Rules ENDSEQ_BRACKET
| SEQ Rules ENDSEQ
| SEQ_BRACKET error ENDSEQ_BRACKET // error recovery
| SEQ error ENDSEQ // error recovery

UpdateRule
: DirectCallExpression UPDATE Term

CallRule
: CALL DirectCallExpression
| DirectCallExpression
| CALL IndirectCallExpression
| IndirectCallExpression

Attribute
: BasicAttribute
| ExpressionAttribute

Attributes
: Attributes COMMA Attribute
| Attribute

BasicAttribute
: Identifier

ExpressionAttribute
: Identifier Term
